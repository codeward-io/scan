# Vulnerability Policies

Vulnerability policies are the cornerstone of Codeward's security governance. They define how your system responds to security vulnerabilities detected in dependencies and code, providing automated protection against known security risks.

## üéØ Overview

Vulnerability policies use the industry-standard [Trivy](https://trivy.dev/) scanner to detect:

- **Known CVEs** in dependencies
- **Security advisories** from package registries
- **Vulnerability severity** classifications (CRITICAL, HIGH, MEDIUM, LOW)
- **Fix availability** and recommended versions
- **Dependency relationships** and transitive vulnerabilities

## üìã Policy Structure

### **Basic Vulnerability Policy**

```json
{
  "vulnerability": [{
    "name": "Critical vulnerability protection",
    "disabled": false,
    "actions": {
      "new": "block",
      "existing": "warn", 
      "removed": "info",
      "changed": "warn"
    },
    "rules": {
      "severity": [{"type": "eq", "value": "CRITICAL"}]
    },
    "outputs": [{
      "format": "markdown",
      "destination": "git:pr",
      "fields": ["VulnerabilityID", "PkgName", "Severity", "FixedVersion"],
      "changes": ["new", "existing"]
    }]
  }]
}
```

### **Policy Components**

#### **1. Name and Description**
```json
{
  "name": "Critical vulnerability blocking",
  "description": "Prevents critical security vulnerabilities from entering production"
}
```

#### **2. Policy Disabling**
```json
{
  "disabled": false,  // Set to true to disable this policy
  "name": "Policy name"
}
```

Individual policies can be disabled by setting `"disabled": true`. When disabled, the policy is skipped during scanning and the disabled policy names are logged for transparency.

#### **3. Actions Configuration**
```json
{
  "actions": {
    "new": "block",      // Block new critical vulnerabilities
    "existing": "warn",  // Warn about existing vulnerabilities  
    "removed": "info",   // Track security improvements
    "changed": "warn"    // Review vulnerability changes
  }
}
```

#### **3. Filtering Rules**
```json
{
  "rules": {
    "severity": [
      {"type": "eq", "value": "CRITICAL"},
      {"type": "eq", "value": "HIGH"}
    ],
    "pkg_name": [
      {"type": "contains", "value": "crypto"},
      {"type": "ne", "value": "safe-crypto-lib"}
    ],
    "vulnerability_id": [
      {"type": "regex", "value": "CVE-2023-.*"}
    ]
  }
}
```

## üîç Available Rule Fields

### **Vulnerability-Specific Fields**

| Field | Description | Example Values |
|-------|-------------|----------------|
| `vulnerability_id` | CVE or advisory ID | `CVE-2023-12345`, `GHSA-xxxx-xxxx-xxxx` |
| `severity` | Vulnerability severity | `CRITICAL`, `HIGH`, `MEDIUM`, `LOW` |
| `pkg_id` | Package identifier | `lodash@4.17.19`, `express@4.17.1` |
| `pkg_name` | Package name only | `lodash`, `express`, `react` |
| `installed_version` | Currently installed version | `4.17.19`, `1.2.3` |
| `fixed_version` | Version with fix | `4.17.21`, `1.2.4` |
| `status` | Vulnerability status | `fixed`, `affected`, `under_investigation` |

### **Extended Fields (with dependency_tree: true)**

| Field | Description | Example Values |
|-------|-------------|----------------|
| `relationship` | Dependency type | `direct`, `indirect` |
| `children` | Child dependencies | `["child1", "child2"]` |
| `parents` | Parent dependencies | `["parent1", "parent2"]` |
| `targets` | Package targets | `["./package.json", "./backend/package.json"]` |

## üéõÔ∏è Rule Operators

### **Equality Operators**
```json
{
  "severity": [
    {"type": "eq", "value": "CRITICAL"},     // Equals
    {"type": "ne", "value": "LOW"}           // Not equals
  ]
}
```

### **Comparison Operators**
```json
{
  "cvss_score": [
    {"type": "gt", "value": "7.0"},          // Greater than
    {"type": "ge", "value": "7.0"},          // Greater than or equal
    {"type": "lt", "value": "4.0"},          // Less than
    {"type": "le", "value": "4.0"}           // Less than or equal
  ]
}
```

### **String Operators**
```json
{
  "pkg_name": [
    {"type": "contains", "value": "crypto"},      // Contains substring
    {"type": "not_contains", "value": "test"},    // Does not contain
    {"type": "hasPrefix", "value": "@company/"},  // Starts with
    {"type": "hasSuffix", "value": "-dev"},       // Ends with
    {"type": "regex", "value": "^react-.*"}       // Regular expression
  ]
}
```

### **Existence Operators**
```json
{
  "fixed_version": [
    {"type": "exists"},                      // Fix available
    {"type": "not_exists"}                   // No fix available
  ]
}
```

## üìä Real-World Policy Examples

### **Enterprise Security Policy**

```json
{
  "vulnerability": [
    {
      "name": "Critical vulnerability blocking",
      "actions": {
        "new": "block",
        "existing": "warn",
        "removed": "info"
      },
      "rules": {
        "severity": [{"type": "eq", "value": "CRITICAL"}],
        "fixed_version": [{"type": "exists"}]  // Only block if fix available
      },
      "outputs": [{
        "format": "markdown",
        "destination": "git:pr",
        "title": "üö® Critical Security Vulnerabilities",
        "fields": ["VulnerabilityID", "PkgName", "Severity", "FixedVersion"],
        "group_by": ["PkgName"],
        "changes": ["new", "existing"]
      }]
    },
    {
      "name": "High severity tracking",
      "actions": {
        "new": "warn",
        "existing": "info",
        "removed": "info"
      },
      "rules": {
        "severity": [{"type": "eq", "value": "HIGH"}]
      },
      "outputs": [{
        "format": "markdown",
        "destination": "git:pr",
        "title": "‚ö†Ô∏è High Severity Vulnerabilities",
        "fields": ["VulnerabilityID", "PkgName", "InstalledVersion", "FixedVersion"],
        "changes": ["new"]
      }]
    }
  ]
}
```

### **Open Source Project Policy**

```json
{
  "vulnerability": [{
    "name": "Community security standards",
    "actions": {
      "new": "warn",       // Less strict for open source
      "existing": "info",
      "removed": "info"
    },
    "rules": {
      "severity": [
        {"type": "eq", "value": "CRITICAL"},
        {"type": "eq", "value": "HIGH"}
      ]
    },
    "outputs": [{
      "format": "markdown",
      "destination": "git:pr",
      "title": "Security Advisory",
      "comment": "Please review and consider updating these dependencies for better security.",
      "fields": ["VulnerabilityID", "PkgName", "Severity", "FixedVersion"],
      "changes": ["new", "existing"]
    }]
  }]
}
```

### **Development Environment Policy**

```json
{
  "vulnerability": [{
    "name": "Development environment scanning",
    "actions": {
      "new": "info",       // Non-blocking in development
      "existing": "info",
      "removed": "info"
    },
    "rules": {
      "severity": [
        {"type": "eq", "value": "CRITICAL"},
        {"type": "eq", "value": "HIGH"},
        {"type": "eq", "value": "MEDIUM"}
      ],
      "relationship": [{"type": "eq", "value": "direct"}]  // Only direct dependencies
    },
    "outputs": [{
      "format": "json",
      "destination": "file:security-report.json",
      "fields": ["VulnerabilityID", "PkgName", "Severity", "Relationship"]
    }]
  }]
}
```

## üéØ Advanced Filtering

### **Package-Specific Policies**

```json
{
  "vulnerability": [
    {
      "name": "Critical infrastructure packages",
      "actions": {"new": "block", "existing": "block"},
      "rules": {
        "pkg_name": [
          {"type": "eq", "value": "express"},
          {"type": "eq", "value": "lodash"},
          {"type": "eq", "value": "react"}
        ],
        "severity": [
          {"type": "eq", "value": "CRITICAL"},
          {"type": "eq", "value": "HIGH"}
        ]
      }
    },
    {
      "name": "Non-critical packages",
      "actions": {"new": "warn", "existing": "info"},
      "rules": {
        "pkg_name": [
          {"type": "ne", "value": "express"},
          {"type": "ne", "value": "lodash"},
          {"type": "ne", "value": "react"}
        ],
        "severity": [{"type": "eq", "value": "CRITICAL"}]
      }
    }
  ]
}
```

### **Version-Based Filtering**

```json
{
  "vulnerability": [{
    "name": "Legacy version protection",
    "actions": {"new": "block", "existing": "warn"},
    "rules": {
      "installed_version": [
        {"type": "regex", "value": "^[0-1]\\..*"}  // Block major versions 0-1
      ],
      "severity": [
        {"type": "eq", "value": "CRITICAL"},
        {"type": "eq", "value": "HIGH"}
      ]
    }
  }]
}
```

### **Dependency Relationship Filtering**

```json
{
  "vulnerability": [{
    "name": "Direct dependency focus",
    "actions": {"new": "block", "existing": "warn"},
    "rules": {
      "relationship": [{"type": "eq", "value": "direct"}],
      "severity": [{"type": "eq", "value": "CRITICAL"}]
    },
    "outputs": [{
      "format": "markdown",
      "destination": "git:pr",
      "fields": ["VulnerabilityID", "PkgName", "Relationship", "Parents"],
      "group_by": ["Relationship"]
    }]
  }]
}
```

## üì§ Output Customization

### **Field Selection**

**Essential Fields:**
```json
{
  "fields": ["VulnerabilityID", "PkgName", "Severity", "FixedVersion"]
}
```

**Detailed Analysis:**
```json
{
  "fields": [
    "VulnerabilityID", "PkgID", "PkgName", 
    "InstalledVersion", "FixedVersion", 
    "Status", "Severity", "Relationship",
    "Children", "Parents", "Targets"
  ]
}
```

**Minimal Reporting:**
```json
{
  "fields": ["PkgName", "Severity"]
}
```

### **Grouping Strategies**

**By Package:**
```json
{
  "group_by": ["PkgName"],
  "title": "Vulnerabilities by Package"
}
```

**By Severity:**
```json
{
  "group_by": ["Severity"],
  "title": "Vulnerabilities by Severity Level"
}
```

**By Package and Severity:**
```json
{
  "group_by": ["PkgName", "Severity"],
  "title": "Detailed Vulnerability Breakdown"
}
```

## üö® Emergency Procedures

### **Hotfix Bypass**

For urgent production fixes, temporarily modify policy actions:

```json
{
  "vulnerability": [{
    "name": "Emergency bypass policy",
    "actions": {
      "new": "warn",      // Changed from "block"
      "existing": "info",
      "removed": "info"
    },
    "rules": {
      "severity": [{"type": "eq", "value": "CRITICAL"}]
    },
    "comment": "TEMPORARY: Emergency bypass for hotfix deployment"
  }]
}
```

### **Exception Management**

Exclude specific known vulnerabilities:

```json
{
  "vulnerability": [{
    "name": "Standard vulnerability policy",
    "actions": {"new": "block", "existing": "warn"},
    "rules": {
      "severity": [{"type": "eq", "value": "CRITICAL"}],
      "vulnerability_id": [
        {"type": "ne", "value": "CVE-2023-ACCEPTED-RISK"}  // Accepted exception
      ]
    }
  }]
}
```

## üìä Monitoring and Metrics

### **Vulnerability Trends**

Track security improvements over time:

```json
{
  "outputs": [{
    "format": "json",
    "destination": "file:metrics/vulnerability-trends.json",
    "fields": ["VulnerabilityID", "Severity", "PkgName", "Status"],
    "changes": ["new", "removed"],
    "title": "Security Metrics Export"
  }]
}
```

### **Package Risk Assessment**

Identify high-risk packages:

```json
{
  "outputs": [{
    "format": "markdown",
    "destination": "file:reports/package-risk.md",
    "fields": ["PkgName", "Severity", "Children"],
    "group_by": ["PkgName"],
    "title": "Package Risk Assessment",
    "comment": "Packages with most vulnerabilities"
  }]
}
```

---

**Next Steps:**
- Configure [License Policies](./license.md)
- Set up [Package Policies](./package.md)  
- Learn about [Custom Validation](./validation.md)

## Related Topics

- [License Policies](./license.md)
- [Package Policies](./package.md)
- [Custom Validation](./validation.md)
- [Output Formats](../output/formats.md)
- [Configuration Overview](../configuration/overview.md)
